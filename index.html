<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Great Dalmuti by Joon Hee</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="game-container">
        <h1>The Great Dalmuti by Joon Hee</h1>
        <p>게임에 참여할 플레이어 수를 선택하세요:</p>
        <button id="startGame3">사용자 + 2명</button>
        <button id="startGame4">사용자 + 3명</button>
        <button id="showRules">게임 규칙 보기</button>
        <div id="gameArea" style="display: none;">
            <div id="gameInfo">
                <p>남은 카드: <span id="remainingCards">0</span></p>
                <p>현재 턴: <span id="turnCount">0</span></p>
            </div>
            <div class="game-play">
                <div class="player-hand" id="playerHand"></div>
                <table id="turnLog">
                    <thead>
                        <tr>
                            <th>사용자</th>
                            <th>플레이어 1</th>
                            <th>플레이어 2</th>
                            <th>플레이어 3</th>
                        </tr>
                    </thead>
                    <tbody id="logBody"></tbody>
                </table>
            </div>
        </div>
        <div id="rules" style="display: none;">
            <h2>달무티 게임 규칙</h2>
            <p>1. 각 플레이어는 섞인 카드 덱에서 카드를 나누어 가집니다.</p>
            <p>2. 게임은 계급이 낮은 카드(1이 가장 낮음)를 먼저 내는 순서로 진행됩니다.</p>
            <p>3. 한 턴에서 동일한 계급의 카드 여러 장을 낼 수 있습니다.</p>
            <p>4. 가장 먼저 모든 카드를 소진한 플레이어가 승리합니다.</p>
            <button id="hideRules">닫기</button>
        </div>
    </div>
    <script>
        let players = [];
        let currentTurn = 0;
        let lastPlayedCards = [];

        window.onload = () => {
            document.getElementById('startGame3').addEventListener('click', () => startGame(3));
            document.getElementById('startGame4').addEventListener('click', () => startGame(4));
            document.getElementById('showRules').addEventListener('click', showRules);
            document.getElementById('hideRules').addEventListener('click', hideRules);
        };

        function createDeck() {
            const deck = [];
            const maxRank = 12; // 카드의 최대 계급 설정

            for (let rank = 1; rank <= maxRank; rank++) {
                for (let count = 0; count < rank; count++) {
                    deck.push(rank);
                }
            }
            return deck.sort(() => Math.random() - 0.5);
        }

        function distributeCards(deck, playerCount) {
            const players = Array(playerCount).fill().map(() => []);
            let currentIndex = 0;

            while (deck.length) {
                players[currentIndex % playerCount].push(deck.pop());
                currentIndex++;
            }

            players.forEach(hand => hand.sort((a, b) => a - b));
            return players;
        }

        function renderHand(hand) {
            const handDiv = document.getElementById('playerHand');
            handDiv.innerHTML = hand
                .map((card, index) => `<div class='card' data-index='${index}' onclick='selectCard(${index})'>${card}</div>`)
                .join('');
        }

        function selectCard(index) {
            const cardElements = document.querySelectorAll(`.card[data-index='${index}']`);
            cardElements.forEach(card => card.classList.toggle('selected'));
        }

        function playSelectedCards() {
            const selectedCards = document.querySelectorAll('.card.selected');
            if (selectedCards.length === 0) {
                alert('카드를 선택하세요.');
                return;
            }

            const selectedValues = Array.from(selectedCards).map(card => parseInt(card.textContent));
            const isValid = validatePlay(selectedValues);
            if (!isValid) {
                alert('규칙에 맞지 않는 카드입니다.');
                return;
            }

            selectedValues.forEach(value => {
                const index = players[0].indexOf(value);
                if (index !== -1) players[0].splice(index, 1);
            });

            lastPlayedCards = selectedValues;
            processTurn(selectedValues);
            renderHand(players[0]);
            updateGameInfo();
        }

        function validatePlay(cards) {
            if (cards.length === 0) return false;

            const rank = cards[0];
            if (!cards.every(card => card === rank)) return false;

            if (lastPlayedCards.length > 0 && rank >= lastPlayedCards[0]) return false;

            return true;
        }

        function processTurn(playerCards) {
            const turnLog = [playerCards];

            for (let i = 1; i < players.length; i++) {
                const computerCards = computerPlay();
                turnLog.push(computerCards);
                lastPlayedCards = computerCards;
            }

            logTurn(turnLog);
            currentTurn++;
            checkGameEnd();
        }

        function computerPlay() {
            const hand = players[currentTurn % players.length];
            const playableCards = hand.filter(card => lastPlayedCards.length === 0 || card < lastPlayedCards[0]);

            if (playableCards.length === 0) return [];

            const selectedRank = Math.min(...playableCards);
            const selectedCards = hand.filter(card => card === selectedRank);
            players[currentTurn % players.length] = hand.filter(card => card !== selectedRank);

            return selectedCards;
        }

        function checkGameEnd() {
            if (players[0].length === 0) {
                alert('사용자가 승리했습니다!');
            } else if (players.slice(1).every(p => p.length === 0)) {
                alert('컴퓨터가 승리했습니다!');
            }
        }

        function updateGameInfo() {
            document.getElementById('remainingCards').textContent = players[0].length;
            document.getElementById('turnCount').textContent = currentTurn;
        }

        function logTurn(playerCards) {
            const logBody = document.getElementById('logBody');
            const row = document.createElement('tr');
            playerCards.forEach(cards => {
                const cell = document.createElement('td');
                cell.textContent = cards.join(', ') || '-';
                row.appendChild(cell);
            });
            logBody.appendChild(row);
        }

        function startGame(playerCount) {
            const deck = createDeck();
            players = distributeCards(deck, playerCount);
            currentTurn = 0;
            lastPlayedCards = [];

            document.querySelector('.game-container > p').style.display = 'none';
            document.querySelectorAll('button').forEach(button => button.style.display = 'none');
            document.getElementById('gameArea').style.display = 'block';

            renderHand(players[0]);
            updateGameInfo();
            logTurn(Array(playerCount).fill([]));
        }

        function showRules() {
            document.getElementById('rules').style.display = 'block';
        }

        function hideRules() {
            document.getElementById('rules').style.display = 'none';
        }
    </script>
</body>
</html>
